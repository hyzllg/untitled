目前系统日期 20280727

select * from acct_payment_schedule s  where s.objectno in (
'787-502805153301143206'
);

select * from acct_payment_schedule s  where s.objectno in (
'787-502805153301158176'
);



1	46161166672320931683	787-502805153301143206	1	2028/06/15	1	2028/05/15	822.64	822.64	31.64	31.64		2.90	2.90	0.00	0.00	0.00000000		0.00000000	2028/07/26	29.15	29.15											857.18	2028/07/26			13			Y	2021/2/25 21:12:03	2021/3/8 10:56:25			502805153301143201	202101260000002008						7017	787	0
2	46161166672320931684	787-502805153301143206	2	2028/07/15	1	2028/06/15	826.89	786.68	23.35	23.15		0.88	0.78	0.00	0.00	0.00000000		0.00000000	2028/08/23	29.15	29.15											851.12				12			Y	2021/2/25 21:12:03	2028/8/23 17:38:59			502805153301143201	202101260000002008						7017	787	0
3	46161166672320931685	787-502805153301143206	3	2028/08/15	1	2028/07/15	831.16	0.00	18.45	0.00		0.57	0.00	0.00	0.00	0.00000000		0.00000000	2028/08/23	29.15	0.00											850.18				12			Y	2021/2/25 21:12:03	2028/8/23 17:38:59			502805153301143201	202101260000002008						7017	787	0
4	46161166672320931686	787-502805153301143206	4	2028/09/15	1	2028/08/15	835.45	0.00	13.02	0.00		0.00	0.00	0.00	0.00	0.00000000		0.00000000	2028/08/23	29.15	0.00											848.47				11			Y	2021/2/25 21:12:03	2028/8/23 17:38:59			502805153301143201	202101260000002008						7017	787	0
5	46161166672320931687	787-502805153301143206	5	2028/10/15	1	2028/09/15	839.77	0.00	8.70	0.00		0.00	0.00	0.00	0.00	0.00000000		0.00000000	2028/08/23	29.15	0.00											848.47				11			Y	2021/2/25 21:12:03	2028/8/23 17:38:59			502805153301143201	202101260000002008						7017	787	0
6	46161166672320931688	787-502805153301143206	6	2028/11/15	1	2028/10/15	844.09	0.00	4.36	0.00		0.00	0.00	0.00	0.00	0.00000000		0.00000000	2028/08/23	29.15	0.00											848.45				11			Y	2021/2/25 21:12:03	2028/8/23 17:38:59			502805153301143201	202101260000002008						7017	787	0


1	46161179833699631196	787-502805153301158176	1	2028/06/15	1	2028/05/15	822.64	822.64	31.64	31.64		2.90	2.90	0.00	0.00	0.00000000		0.00000000	2028/07/26	29.15	29.15											857.18	2028/07/26			13			Y	2028/5/15 9:45:36	2021/3/8 10:56:25			502805153301158157	202101280000000010						7017	787	0
2	46161179833699631197	787-502805153301158176	2	2028/07/15	1	2028/06/15	826.89	612.92	24.19	23.15		1.30	0.78	0.00	0.00	0.00000000		0.00000000	2028/08/23	29.15	29.15											852.38				12			Y	2028/5/15 9:45:36	2028/8/23 17:41:42			502805153301158157	202101280000000010						7017	787	0
3	46161179833699631198	787-502805153301158176	3	2028/08/15	1	2028/07/15	831.16	0.00	18.45	0.00		0.57	0.00	0.00	0.00	0.00000000		0.00000000	2028/08/23	29.15	0.00											850.18				12			Y	2028/5/15 9:45:36	2028/8/23 17:41:42			502805153301158157	202101280000000010						7017	787	0
4	46161179833699631199	787-502805153301158176	4	2028/09/15	1	2028/08/15	835.45	0.00	13.02	0.00		0.00	0.00	0.00	0.00	0.00000000		0.00000000	2028/08/23	29.15	0.00											848.47				11			Y	2028/5/15 9:45:36	2028/8/23 17:41:42			502805153301158157	202101280000000010						7017	787	0
5	46161179833699631200	787-502805153301158176	5	2028/10/15	1	2028/09/15	839.77	0.00	8.70	0.00		0.00	0.00	0.00	0.00	0.00000000		0.00000000	2028/08/23	29.15	0.00											848.47				11			Y	2028/5/15 9:45:36	2028/8/23 17:41:42			502805153301158157	202101280000000010						7017	787	0
6	46161179833699631201	787-502805153301158176	6	2028/11/15	1	2028/10/15	844.09	0.00	4.36	0.00		0.00	0.00	0.00	0.00	0.00000000		0.00000000	2028/08/23	29.15	0.00											848.45				11			Y	2028/5/15 9:45:36	2028/8/23 17:41:42			502805153301158157	202101280000000010						7017	787	0


2028/07/15

select sysdate, to_date('2028/10/15','yyyy/MM/dd')+80 from dual;--2028/10/03  第5期
SELECT to_date('2028/10/03','yyyy/MM/dd')-to_date('2028/09/15','yyyy/MM/dd') FROM dual;--18

29050219506765000000000003080011533010003000001533030001000001533020001000001向义莉8992030100096551502805153301143201PBLG202131171845006699805202807153390.6836.890.673428.2420281003FINAL_CLAIM
29050219506765000000000003080021533010003000001533030001000001533020001000001高义8992030100042795502805153301158157PBLG202131171845006718805202807153564.4437.731.093603.3220281003FINAL_CLAIM

本金：逾期未还期次本金，第1、2、3、4、5、6期，40.21+831.16+835.45+839.77+844.09=3390.68

逾期本金(不含当前期次本金)：40.21+831.16+835.45=1706.82
正常本金(含当前期次本金)：839.77+844.09=1683.86
利息：逾期未还期次利息：第4、5、6期正常本金(1683.86)*利率0.062/360*18=5.22   5.22+0.2+18.45+13.02=36.89
罚息：逾期未还期次罚息：第1、2、3期，0.1+0.57=0.67

select a.businesssum,a.overduedays,a.serialno,a.putoutno,a.customername,a.accountno,a.loanrate,a.feeamt80,a.feeamtall,a.feebackamount,a.apply_no,a.normalbalance,a.overduebalance from acct_loan a where a.serialno in (
'787-502805153301143206') for update;



本金：逾期未还期次本金，第1、2、3、4、5、6期，213.97+831.16+835.45+839.77+844.09=3564.44

逾期本金(不含当前期次本金)：213.97+831.16+835.45=1880.58
正常本金(含当前期次本金)：839.77+844.09=1683.86
利息：逾期未还期次利息：第4、5、6期正常本金(1683.86)*利率0.062/360*18=5.22   5.22+1.04+18.45+13.02=37.73
罚息：逾期未还期次罚息：第1、2、3期，0.58+0.57=1.15

select a.businesssum,a.overduedays,a.serialno,a.putoutno,a.customername,a.accountno,a.loanrate,a.feeamt80,a.feeamtall,a.feebackamount,a.apply_no,a.normalbalance,a.overduebalance from acct_loan a where a.serialno in (
'787-502805153301158176') for update;




2028/10/3

460100000030811
select * from acct_file_task_detail where task_id = '460100000030811' for update;
select * from acct_file_task t where t.id = '460100000030811' for update;



select --acct_seq.nextval , @taskId, 
rownum , 
--'29050219506765000000000006221528533000004000001533030001000001533020001000001班花8992040100030120502809202980162333'
--'29050219506765000000000006221528533000004000001533030001000001533020001000001班花8992040100030120502809202980162333'
'2905021950676500000000000308002'||rownum
--||'533000004000001533030001000001533020001000001'
||'533010003000001533030001000001533020001000001'--还呗
--||'533000007000001533030001000001533020001000001'--拍拍贷
||a.customername||''||a.accountno||''
||ap.result_seq_no||''||putoutno||'80520280715'||本金||''||利息||''||罚息||''||合计||''||replace('2028/10/03','/','')||'FINAL_CLAIM'
, null, 2, 'system', to_date('17-06-2020 17:25:49', 'dd-mm-yyyy hh24:mi:ss'), 'system', sysdate, null, null, a.putoutno
from (
with tseq as (
 --某期的还款金额
 select objectno,paycorpusamt 应本金,ACTUALPAYCORPUSAMT 实还本金
 ,(to_date('2028/10/03','yyyy/mm/dd')-to_date(intedate,'yyyy/mm/dd') )有效天数
,payinteamt 应利息
--,payinteamt*((to_date('2025/10/15','yyyy/mm/dd')-to_date(intedate,'yyyy/mm/dd'))/(to_date(paydate,'yyyy/mm/dd')-to_date(intedate,'yyyy/mm/dd'))) 应利息
,actualpayinteamt 实还利息
,paycompdinteamt 应复利,ACTUALCOMPDINTEAMT 实还复利
,ps.payfineamt 应罚息,ps.actualfineamt 实罚息
,seqid,paydate 最早还款日 
 from acct_payment_schedule  ps
 where 
  '2028/10/03' between ps.intedate and paydate
 and objectno ='787-502805153301158176' and finishdate is null 
),tall as (
select * from acct_payment_schedule a
 where objectno ='787-502805153301158176' and finishdate is null 
),tc as (
select a.*,应利息,实还利息 from tall a,tseq s where a.objectno=s.objectno and a.seqid<s.seqid
),tb1 as (
select a.objectno,sum(a.paycorpusamt-ACTUALPAYCORPUSAMT) 剩余本金
from tall a,tseq s where a.objectno=s.objectno and a.seqid<=s.seqid
group by a.objectno
)

,tb as (
  select tb1.objectno,剩余本金*利率 应利息,实还利息,seqid from (select seqid,al.serialno,al.loanrate/100/360*有效天数 利率,s.实还利息 from acct_loan al,tseq s where al.serialno=s.objectno) ar
  ,tb1 where ar.serialno=tb1.objectno
)
,tsum as (
select 应本金-实还本金 本金 ,round((应利息+应利息2-实还利息-实还利息2),2) 利息,应复利-实还复利 复利,应罚息-实还罚息 罚息
 ,s.* from (
select a.objectno,sum(a.paycorpusamt) 应本金,sum(a.ACTUALPAYCORPUSAMT) 实还本金
,sum(c.payinteamt)应利息,sum(c.actualpayinteamt) 实还利息
,sum(distinct b.应利息)应利息2,sum(distinct b.实还利息) 实还利息2
,sum(a.paycompdinteamt)应复利,sum(a.ACTUALCOMPDINTEAMT) 实还复利
,sum(a.payfineamt)应罚息,sum(a.actualfineamt) 实还罚息
,min(a.seqid) 最早期次,min(a.paydate) 最早还款日,max(a.seqid) 最后期次 ,max(a.paydate) 最后还款日 
from tall a
 left join tb b  on a.objectno=b.objectno and a.seqid=b.seqid
 left join tc c  on a.objectno=c.objectno and a.seqid=c.seqid
 group by a.objectno) s
 )
 select 应本金-实还本金+应罚息-实还罚息+利息 合计,s.* from tsum s
)r inner join acct_loan a  on r.objectno=a.serialno 
left join acct_fund_apply ap on a.putoutno=ap.policy_no
;